<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8"/>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Library Score</title>
</head>

<body>
	<div id="scores"></div>
	<div class="column is-one-quarter" class="container is-fluid">
		<form id="inputForm" method="get">
			<div class = "field">
				<input class ="input" type="text" name="input1" placeholder="Input Library Name"><br>
			</div>
			<div class = "field">
				<input class ="input" type="text" name="input2" placeholder="Input Library Name"><br>
			</div>
			<div class = "field is-hidden extra">
				<input class="input" type="text" name="input3" placeholder="Input Library Name"><br>
			</div>
			<div class = "field is-hidden extra">
				<input class ="input" type="text" name="input4" placeholder="Input Library Name"><br>
			</div>
			<div class = "field is-hidden extra">
				<input class ="input" type="text" name="input5" placeholder="Input Library Name"><br>
			</div>
			<div class="field is-grouped is-grouped-right">
				<p class = "control">
					<a class="button is-light" id="add">Add Additional Field</a>
				</p>
				<p class="control">
					<input class ="button is-primary" type="submit" value="Compare Scores" id="submitButton">
				</p>
			</div>
		</form>
	</div>






	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.1/css/bulma.css">


	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
		<script>
		
		var libraryScores = {};
		
		function some(promises){
			var d = $.Deferred(), results = [];
			var remaining = promises.length;
			for(var i = 0; i < promises.length; i++){
				promises[i].then(function(res){
					results.push(res); // on success, add to results
				}).always(function(res){
					remaining--; // always mark as finished
					if(!remaining) d.resolve(results);
				})
			}
			return d.promise(); // return a promise on the remaining values
		}
		
		function getQueryParameters()
		{
			var paramsString = window.location.search.substr(1);
			var searchParams = new URLSearchParams(paramsString);
			/*var params = []
			for (var key of searchParams.keys())
			{
				params[key]=searchParams.get(key);
			}*/
			return Array.from(searchParams.values());
		}
		
		function ajaxRequests(params)
		{
			var ajaxArray = {};
			for(var library of params)
			{
				if(library != "")
				{
					ajaxArray[library] = "https://api.npms.io/v2/package/" + library;
				}
			}
			return ajaxArray;
		}
		
		function handleQuery()
		{
			
			if(window.location.search.length)
			{
				var params = getQueryParameters();
				var libraries = ajaxRequests(params);
				var requests = [];
				for(var library in libraries)
				{
					requests.push(getJson(library, libraries[library]));
				}
				some(requests).then( function(objects){
					console.log(libraryScores);
					var html = "<div class='column is-one-quarter'>";
					for(var library in libraryScores)
					{
						html += '<div class="notification"><span class="has-text-weight-bold">' + library + "</span> : " + libraryScores[library] + "</div>";
					}
					html += '</div>';
					$("body").prepend(html);
				});
				list = Object.keys(libraryScores);
				$('input[name=input1]').attr("value", list[0] !== undefined ? list[0] : "");
				$('input[name=input2]').attr("value", list[1] !== undefined ? list[1] : "");
				$('input[name=input3]').attr("value", list[2] !== undefined ? list[2] : "");
				$('input[name=input4]').attr("value", list[3] !== undefined ? list[3] : "");
				$('input[name=input5]').attr("value", list[4] !== undefined ? list[4] : "");
				
				if($('input[name=input3]').attr("value") != "")
				{
					$('input[name=input3]').parent().removeClass("is-hidden");
				}
				
				if($('input[name=input4]').attr("value") != "")
				{
					$('input[name=input4]').parent().removeClass("is-hidden");
				}
				
				if($('input[name=input5]').attr("value") != "")
				{
					$('input[name=input5]').parent().removeClass("is-hidden");
				}
				
				
			}
			
		}
		
		function getJson(library, iurl)
		{
			return $.getJSON({
				url:iurl,
				success: function(json){
					libraryScores[library] = Math.round(json.score.final*100,0)+"%";
				},
				fail: function(){
					console.log("Could not load" + iurl);
				}
			});
		}
		
		function registerClickEvents()
		{
			$("#add").click(function(event){
				var extraFields = $(".extra.is-hidden");
				if(extraFields.length != 0)
				{
					extraFields.first().removeClass("is-hidden");
				}
				if(extraFields.length == 1)
				{
					$("#add").addClass("is-hidden");
				}
			});
		}
		
		$(document).ready(function(){
			handleQuery();
			registerClickEvents();
			
			
			
		});
	</script>
	
	
</body>

</html>